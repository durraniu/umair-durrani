---
title: "Getting and plotting real-time traffic data"
description: "Using {hereR} to get live speed"
format: 
  html:
    page-layout: full
image: https://media.giphy.com/media/JOjumF8rHUHINyKObk/giphy.gif
warning: false
toc: true
date: "2023-09-23"
categories:
  - visualization
  - hereR
  - traffic
---

This post introduces you to the [`hereR`](https://munterfi.github.io/hereR/) package that enables you to get real-time speed (and other) data via the [HERE Traffic API](https://developer.here.com/documentation/traffic-api/api-reference.html). I will be requesting data for the cities of Windsor and Toronto in Ontario, Canada.

Requesting data via the API requires an API key that you can create as described in the [instructions](https://munterfi.github.io/hereR/#usage). Once you get and set the `api_key`, you are ready to request the data. Note that there is a rate limit to how much data you can request everyday.

Let's start by loading the package:

```{r}
library(hereR)
```

```{r, echo=FALSE}
api_key <- Sys.getenv("HERE_API_KEY")
```

## Getting the spatial polygons of cities

The `hereR` package requires spatial polygons of the areas for which the traffic data is requested. Therefore, the first step is to get the bounding boxes of Windsor and Toronto via the `osmdata` package:

```{r}
library(osmdata)

city1 <- "Windsor, Ontario"
city2 <- "Toronto, Ontario"

bbox1 <- getbb(city1)
bbox2 <- getbb(city2)

# Windsor bounding box
print(bbox1)
```

Next, we get the spatial data for Ontario via the `geodata` package:

```{r}
library(geodata)
library(sf)

cdn <- geodata::gadm(country = "can", level = 1, path = tempdir())
ont <- cdn[9,]

ont <- st_as_sf(ont)
ont
```

As you can see, `ont` is a simple feature (`sf`) object with geometry type of multipolygon. Bounding boxes can now be used to extract the data for the two cities only:

```{r}
windsor <- st_crop(ont, 
                  xmin=bbox1[1, 1],
                  xmax=bbox1[1, 2],
                  ymin=bbox1[2, 1],
                  ymax=bbox1[2, 2])

toronto <- st_crop(ont, 
                   xmin=bbox2[1, 1],
                   xmax=bbox2[1, 2],
                   ymin=bbox2[2, 1],
                   ymax=bbox2[2, 2])

toronto
```

## Requesting the traffic data

Now we are ready to request the traffic data via the `flow` function from the `hereR` package:

```{r}
flows_windsor <- flow(aoi = windsor)
flows_toronto <- flow(aoi = toronto)

head(flows_windsor)
```

Cool. As you can see, the returned data is also of type `sf` but with many variables. Following table contains the descriptions of these variables ([source](https://developer.here.com/documentation/traffic-api/api-reference.html)).

+----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------+
| Variable       | Description                                                                                                                                                                                                                                                                                                                                                                                              | Units             |
+================+==========================================================================================================================================================================================================================================================================================================================================================================================================+===================+
| speed          | The average speed, capped by the speed limit, that current traffic is travelling.                                                                                                                                                                                                                                                                                                                        | meters per second |
+----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------+
| speedUncapped  | The average speed, not capped by the speed limit, that current traffic is travelling.                                                                                                                                                                                                                                                                                                                    | meters per second |
+----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------+
| freeFlow       | The free flow speed speed is a reference speed provided to indicate the speed on the segment at which vehicles should be considered to be able to travel without impediment.                                                                                                                                                                                                                             | meters per second |
+----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------+
| jamFactor      | The number between 0.0 and 10.0 indicating the expected quality of travel. When there is a road closure, the `jamFactor` will be 10.0. As the value approaches 10.0 the quality of travel is getting worse.                                                                                                                                                                                              |                   |
+----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------+
| confidence     | The number between 0.0 and 1.0 indicating the proportion of real time data included in the speed calculation.                                                                                                                                                                                                                                                                                            |                   |
|                |                                                                                                                                                                                                                                                                                                                                                                                                          |                   |
|                | -   0.7 \< `confidence` \<= 1.0 indicates real time speeds                                                                                                                                                                                                                                                                                                                                               |                   |
|                |                                                                                                                                                                                                                                                                                                                                                                                                          |                   |
|                | -   0.5 \< `confidence` \<= 0.7 indicates historical speeds                                                                                                                                                                                                                                                                                                                                              |                   |
|                |                                                                                                                                                                                                                                                                                                                                                                                                          |                   |
|                | -   0.0 \< `confidence` \<= 0.5 indicates speed limit                                                                                                                                                                                                                                                                                                                                                    |                   |
|                |                                                                                                                                                                                                                                                                                                                                                                                                          |                   |
|                | This field can be used to identify whether the data for a location is derived from real time probe sources or historical information only. All confidence data 0.71 and above is based on real-time information, where a confidence value of 0.75 or greater indicates high confidence real-time information. A confidence value equal to 0.70 means that the data is derived from historical data only. |                   |
+----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------+
| traversability | "open" / "closed" / "reversibleNotRoutable"                                                                                                                                                                                                                                                                                                                                                              |                   |
|                |                                                                                                                                                                                                                                                                                                                                                                                                          |                   |
|                | Indicates whether this roadway can be driven.                                                                                                                                                                                                                                                                                                                                                            |                   |
+----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------+

### Plotting speed and jam factor


Following plots show the speed and jam factor side-by-side for Windsor, Ontario roads at `r Sys.time()`. These are interactive maps: You can zoom in/out, hover over or click on the roads to get more information.  

#### Windsor

```{r}
#| code-fold: true
#| code-summary: "Show the code"

library(mapview)
library(leaflet)
library(leafpop)
library(leafem)
library(raster)
library(leafsync)

m1 <- mapview(flows_windsor,
  popup = popupTable(flows_windsor,
    zcol = c(
      "free_flow",
      "speed",
      "jam_factor",
      "confidence"
    )
  ),
  zcol = "speed",
  layer.name = "speed"
)


m2 <- mapview(flows_windsor,
  popup = popupTable(flows_windsor,
    zcol = c(
      "free_flow",
      "speed",
      "jam_factor",
      "confidence"
    )
  ),
  zcol = "jam_factor",
  layer.name = "jam_factor"
)

sync(m1, m2)
```


#### Toronto

Following uses a different base map with Toronto speeds:

```{r}
#| code-fold: true
#| code-summary: "Show the code"

mapview(flows_toronto,
  popup = popupTable(flows_toronto,
    zcol = c(
      "free_flow",
      "speed",
      "jam_factor",
      "confidence"
    )
  ),
  zcol = "speed",
  layer.name = "speed",
  map.types = c("CartoDB.DarkMatter"),
  homebutton = FALSE
) %>%
  leafem::addHomeButton(ext = extent(toronto), group = "Toronto")
```



This workflow can be scaled to larger number of cities and days with the power of Github Actions to get traffic data every day, month, etc.
