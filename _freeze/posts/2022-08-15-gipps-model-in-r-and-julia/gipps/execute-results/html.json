{
  "hash": "925f4587a95934a6c84e5288764aa549",
  "result": {
    "markdown": "---\ntitle: \"Gipps Model in R, Rcpp, and Julia\"\ndescription: \"Race against time\"\nformat: \n  html:\n    page-layout: full\n    toc-location: left\n    html-math-method: katex\nimage: \"carfollow.png\"\ncache: true\nwarning: false\ndate: \"2022-08-15\"\nbibliography: references.bib\n---\n\n\n## Introduction\n\nCar-following behaviour refers to the motion of a vehicle that follows another vehicle in the same lane. Generally, car-following models are used in simulation software that provide other models as well (e.g., lane change model). However, to understand the outputs of a model, it is a good idea to run the model in a programming environment in isolation. This blog post is about running a car-following model - Gipps car-following model [@gipps1981]- in `R` and `Julia` programming languages.\n\n\n::: {.column-margin}\n<iframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/4RxqKvi8Nys?start=278\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n:::\n\nThe equation for Gipps model is shown below. To learn more, see this [wikipedia article](https://en.wikipedia.org/wiki/Gipps%27_model). You may also be interested in listening to Dr. Martin Treiber's lecture on Gipps model (see the right bar). \n\n\n\n\n$$\nv_n(t+\\tau) = {min} \\left\\{v_n(t) + 2.5 a_n\\tau (1-v_n(t)/V_n){(0.025+v_n(t)/V_n)}^{1/2}, \\\\ b_n\\tau+\\sqrt{b_n^2\\tau^2 -b_n [ 2[x_{n-1}(t)-s_{n-1}-x_n(t)] - v_n(t)\\tau- v_{n-1}(t)^2\\hat{b}]}\\right\\}\n$$\n\n\n\nIn the following sections, I will define and apply the functions for Gipps model in both `R` and `Julia`. `Julia` is a [fast programming language](https://julialang.org/) and could be a good environment to implement car-following models for numerical simulations and calibration. But I am pretty new to using `Julia`, so I write `R` first and then convert the syntax to `Julia`. You will see side by side code for both.\n\n## Load libraries\n\n::: {layout=\"[[40,-5,40]]\"}\n### R\n\n\n::: {.cell hash='gipps_cache/html/unnamed-chunk-1_19b3bdbbd455a22e4cbc43133861cd6e'}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(microbenchmark)\n```\n:::\n\n\n### Julia\n\n\n::: {.cell hash='gipps_cache/html/unnamed-chunk-2_b2e4d722e2219dc693a7a0a0aac5fd73'}\n\n```{.julia .cell-code}\nusing CSV\nusing DataFrames\nusing BenchmarkTools\n```\n:::\n\n:::\n\n## Load Data\n\nI have a dataset in a csv file that contains the positions and speeds of a car following another car [based on the cleaned I80 data from @montanino2015]. I load this csv file separately in both `R` and `Julia`\n\n::: {layout=\"[[40,-5,40]]\"}\n### R\n\n\n::: {.cell hash='gipps_cache/html/unnamed-chunk-3_3a8e7dffcd9236ade3e6ee7a84fc45b3'}\n\n```{.r .cell-code}\ndfn1_r <- read_csv(\"dfn1.csv\") %>% select(-X1)\n\nhead(dfn1_r, 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 x 9\n  Vehicle.ID  Time Local.Y PrecVehLocalY  svel PrecVe~1       dV frspa~2 PrecV~3\n       <dbl> <dbl>   <dbl>         <dbl> <dbl>    <dbl>    <dbl>   <dbl>   <dbl>\n1         11   0      50.2          66.2  4.42     4.42 -0.00292    11.6    4.36\n2         11   0.1    50.6          66.6  4.42     4.42 -0.00103    11.6    4.36\n3         11   0.2    51.1          67.1  4.42     4.42  0.00108    11.6    4.36\n# ... with abbreviated variable names 1: PrecVehVel, 2: frspacing,\n#   3: PrecVehLength\n```\n:::\n:::\n\n\n### Julia\n\n\n::: {.cell hash='gipps_cache/html/unnamed-chunk-4_4df7133d94300baa07a3f5c11f761332'}\n\n```{.julia .cell-code}\ndfn1_julia = DataFrame(CSV.File(\"dfn1.csv\"));\n\ndfn1_julia = select!(dfn1_julia, Not(:Column1));\n\nfirst(dfn1_julia, 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n3×9 DataFrame\n Row │ Vehicle.ID  Time     Local.Y  PrecVehLocalY  svel     PrecVehVel  dV    ⋯\n     │ Int64       Float64  Float64  Float64        Float64  Float64     Float ⋯\n─────┼──────────────────────────────────────────────────────────────────────────\n   1 │         11      0.0  50.2051        66.1681  4.42008     4.423    -0.00 ⋯\n   2 │         11      0.1  50.6473        66.6105  4.42202     4.42305  -0.00\n   3 │         11      0.2  51.0897        67.0528  4.42416     4.42308   0.00\n                                                               3 columns omitted\n```\n:::\n:::\n\n:::\n\n## Defining the function for Gipps Model\n\nFollowing is my implementation of functions for the Gipps model. I won't go into the details of each line in the functions. Feel free to reach out if you have any questions/suggestions to improve these functions.\n\nNote that I also implemented another function in `R` where I re-wrote the `for loop` as a function in `Rcpp`. Again, the reason is to speed up the calculations.\n\n::: panel-tabset\n### R\n\n\n::: {.cell hash='gipps_cache/html/unnamed-chunk-5_61dda82a7d4a993b9a06d787e45576b5'}\n\n```{.r .cell-code}\nsimulate_gipps_r <- function(resolution, N, dfn1,\n                             xn1, vn1, xn_first, vn_first, ln, an,\n                             Vn, tau, bn_const, bcap) {\n  ####### Time #############################################\n\n  # Last time frame of the simulation:\n  last_time <- (nrow(dfn1) - 1) * resolution\n\n  # Time vector:\n  Time <- seq(from = 0, to = last_time, by = resolution)\n\n  # Length of the Time vector\n  time_length <- length(Time)\n\n\n\n  list_of_N_veh <- vector(mode = \"list\", length = N)\n\n\n\n\n\n  for (n in seq_along(list_of_N_veh)) {\n\n    ####### Assign names to Lead Vehicle Parameters ##########\n\n    if (n == 1L) {\n\n      # Lead vehicle position\n      xn1 <- dfn1[[xn1]]\n\n      # Lead vehicle speed\n      vn1 <- dfn1[[vn1]]\n    }\n\n    ln1 <- ln[[n]]\n\n    ####### Allocate Vectors ##################################\n\n    # free-flow speed\n    vn_ff <- rep(NA_real_, time_length)\n\n    # car-following speed\n    vn_cf <- rep(NA_real_, time_length)\n\n    # speed\n    vn <- rep(NA_real_, time_length)\n\n    # position\n    xn <- rep(NA_real_, time_length)\n\n    # spacing\n    sn <- rep(NA_real_, time_length)\n\n    # speed difference\n    deltav <- rep(NA_real_, time_length)\n\n    # acceleration rate\n    bn <- rep(NA_real_, time_length)\n\n    ######## Initial values for Following vehicle ##################################\n\n    # speed\n    vn_ff[1] <- vn_first[[n]]\n    vn_cf[1] <- vn_first[[n]]\n    vn[1] <- vn_first[[n]]\n\n    # position\n    xn[1] <- xn_first[[n]]\n\n    # spacing\n    sn[1] <- xn1[1] - xn_first[[n]]\n\n    # speed difference\n    deltav[1] <- vn_first[[n]] - vn1[1]\n\n    ###### Gipps Calculations ############################\n\n    for (t in 2:(time_length - 1)) {\n\n      ## free flow\n      vn_ff[t] <- vn[t - 1] +\n        (2.5 * an * tau * (1 - (vn[t - 1]) / Vn)) * ((0.025 + (vn[t - 1] / Vn))^(0.5))\n\n      ## car following\n      bcap_part_cf <- (((vn1[t - 1])^2) / bcap)\n\n      vn_cf[t] <- (bn_const * tau) +\n        sqrt(\n          ((bn_const^2) * (tau^2)) - (bn_const * (2 * (xn1[t - 1] - ln1 - xn[t - 1]) - (vn[t - 1] * tau) - bcap_part_cf))\n        )\n\n      ## gipps speed\n      if (is.na(vn1[t - 1])) {\n        vn[t] <- vn_ff[t]\n      } else {\n        vn[t] <- min(vn_ff[t], vn_cf[t])\n      }\n\n      ### if the speed is negative, make it zero\n      vn[t] <- ifelse(vn[t] < 0, 0, vn[t])\n\n      ## acceleration\n      bn[t - 1] <- (vn[t] - vn[t - 1]) / (resolution)\n\n      ## position\n      xn[t] <- xn[t - 1] + (vn[t - 1] * resolution) + (0.5 * bn[t - 1] * (resolution)^2)\n\n      # spacing\n      sn[t] <- xn1[t] - xn[t] - ln1\n\n      # speed difference\n      deltav[t] <- vn[t] - vn1[t]\n    }\n    # ################## Result in a dataframe ###################################\n    result_dfn <- data.frame(fvn = n, Time, xn1, vn1, ln1, bcap, bn, xn, vn_ff, vn_cf, vn, sn, deltav)\n\n    list_of_N_veh[[n]] <- result_dfn\n\n    xn1 <- xn\n    vn1 <- vn\n  }\n\n  result <- do.call(\"rbind\", list_of_N_veh)\n\n\n  return(result)\n}\n```\n:::\n\n\n### Julia\n\n\n::: {.cell hash='gipps_cache/html/unnamed-chunk-6_b77cf0b53c0c24f0a2eee43b831853e9'}\n\n```{.julia .cell-code}\nfunction simulate_gipps_julia(resolution, N, dfn1, \n    xn1, vn1, xn_first, vn_first, ln, an, \n    Vn, tau, bn_const, bcap)\n  \n    ####### Time #############################################\n\n    # Last time frame of the simulation:\n    last_time = (nrow(dfn1) - 1) * resolution\n\n    # Time vector:\n    Time = collect( range(0, stop = last_time, step = resolution) )\n\n    # Length of the Time vector\n    time_length = length(Time)\n\n    list_of_N_veh = Vector{Union{DataFrame, Missing}}(missing, N)\n    # sizehint!(list_of_N_veh, N)\n\n    for n in 1:length(list_of_N_veh)\n        ####### Assign names to Lead Vehicle Parameters ##########\n        \n        if (n == 1) \n            \n            # Lead vehicle position\n            xn1 = dfn1[!, xn1]\n            \n            # Lead vehicle speed\n            vn1 = dfn1[!, vn1]\n            \n        end\n\n        ln1 = ln[n]\n\n        ####### Allocate Vectors ##################################\n\n        # free-flow speed\n        vn_ff = Vector{Union{Float64, Missing}}(missing, time_length)\n        \n        # car-following speed\n        vn_cf = Vector{Union{Float64, Missing}}(missing, time_length)\n        \n        # speed\n        vn = Vector{Union{Float64, Missing}}(missing, time_length)\n        \n\n        # position\n        xn = Vector{Union{Float64, Missing}}(missing, time_length)\n        \n\n        # spacing\n        sn = Vector{Union{Float64, Missing}}(missing, time_length)\n        \n\n        # speed difference\n        deltav = Vector{Union{Float64, Missing}}(missing, time_length)\n        \n\n        # acceleration rate\n        bn = Vector{Union{Float64, Missing}}(missing, time_length)\n        \n\n            ######## Initial values for Following vehicle ##################################\n\n        # speed\n        vn_ff[1] = vn_first[n]\n        vn_cf[1] = vn_first[n]\n        vn[1] = vn_first[n]\n\n        # position\n        xn[1] = xn_first[n]\n\n        # spacing\n        sn[1] = xn1[1] - xn_first[n]\n\n        # speed difference\n        deltav[1] = vn_first[n] - vn1[1]\n\n        ###### Gipps Calculations ############################\n        \n        for t in 2:(time_length-1)\n\n            ## free flow\n            vn_ff[t] = vn[t-1] + (2.5 * an * tau * (1 - (vn[t-1])/Vn)) * ((0.025 + (vn[t-1]/Vn))^(0.5))\n\n            ## car following\n            bcap_part_cf = (((vn1[t-1])^2)/bcap)\n\n            vn_cf[t] = (bn_const * tau) + sqrt(((bn_const^2) * (tau^2)) - (bn_const * (2 * (xn1[t-1] - ln1 - xn[t-1]) - (vn[t-1] * tau) - bcap_part_cf)))\n\n            ## gipps speed\n            if (ismissing.(vn1[t-1]))\n            \n            vn[t] = vn_ff[t]\n            \n            else \n            \n            vn[t] = min(vn_ff[t], vn_cf[t] )\n            \n            end\n\n            ### if the speed is negative, make it zero\n            vn[t] = ifelse(vn[t] < 0, 0, vn[t])\n            \n            \n            ## acceleration\n            bn[t-1] = (vn[t] - vn[t-1])/(resolution)\n            \n            \n            \n            ## position\n            xn[t] = xn[t-1] + (vn[t-1] * resolution) + (0.5 * bn[t-1] * (resolution)^2)\n            \n            \n            # spacing\n            sn[t] = xn1[t] - xn[t] - ln1\n            \n            # speed difference\n            deltav[t] = vn[t] - vn1[t]\n\n        end\n\n    # ################## Result in a dataframe ###################################\n        result_dfn = DataFrame(fvn=n, Time =Time, xn1=xn1, vn1=vn1, ln1=ln1, bn=bn, xn=xn, vn=vn, sn=sn, deltav=deltav)\n        \n        \n        list_of_N_veh[n] = result_dfn\n        \n        xn1 = xn\n        vn1 = vn\n\n    end\n\n    result = reduce(vcat, list_of_N_veh)\n\n    return result\n\nend\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nsimulate_gipps_julia (generic function with 1 method)\n```\n:::\n:::\n\n\n### Rcpp\n\n\n::: {.cell hash='gipps_cache/html/unnamed-chunk-7_4e224b6ce8b1e8d56ff7316ec764e4ed'}\n\n```{.rcpp .cell-code}\n#include <cmath>\n#include <Rcpp.h>\nusing namespace Rcpp;\n\n\n\n// [[Rcpp::export]]\nDataFrame for_loop_gipps(double resolution,\n                         int n,\n                         int time_length,\n                         double tau,\n                         double an,\n                         double bn_const,\n                         double Vn,\n                         double bcap,\n                         double ln1,\n\n                         NumericVector Time,\n                         NumericVector vn_ff,\n                         NumericVector vn_cf,\n                         NumericVector vn,\n                         NumericVector vn1,\n                         NumericVector sn,\n                         NumericVector xn,\n                         NumericVector xn1,\n                         NumericVector deltav,\n                         NumericVector bn\n) {\n\n\n  for(int t = 1; t < (time_length-1); t++) {\n\n    // ## free flow\n    vn_ff[t] = vn[t-1] + (2.5 * an * tau * (1 - (vn[t-1])/Vn)) * ((0.025 + pow((vn[t-1]/Vn), 0.5)));\n\n    // if (Rcpp::NumericVector::is_na(vn1[t-1])) {\n    //\n    //   vn1[t-1] = 0;\n    //\n    // } else {\n    //\n    //   vn1[t-1] = vn1[t-1];\n    //\n    //   }\n\n    // ## car following\n    vn_cf[t] = (bn_const * tau) + sqrt(\n      (pow(bn_const,2) * pow(tau,2)) - (bn_const * (2 * (xn1[t-1] - ln1 - xn[t-1]) - (vn[t-1] * tau) - (pow((vn1[t-1]),2)/bcap)))\n    );\n\n    // ## gipps speed\n\n    if (Rcpp::NumericVector::is_na(vn1[t-1])){\n\n      vn[t] = vn_ff[t];\n\n    } else {\n\n      if (vn_ff[t] < vn_cf[t]){\n\n        vn[t] = vn_ff[t];\n\n      } else {\n\n        vn[t] = vn_cf[t];\n\n        }\n\n    }\n\n    // ### if the speed is negative, make it zero\n\n    if (vn[t] < 0) {\n\n      vn[t] = 0;\n\n    } else {\n\n      vn[t] = vn[t];\n\n    }\n\n    // ## acceleration\n    bn[t-1] = (vn[t] - vn[t-1])/(resolution);\n\n    // ## position\n    xn[t] = xn[t-1] + (vn[t-1] * resolution) + (0.5 * bn[t-1] * pow(resolution, 2));\n\n    // # spacing\n    sn[t] = xn1[t] - xn[t];\n\n    // # speed difference\n    deltav[t] = vn[t] - vn1[t];\n\n\n  }\n\n  DataFrame df = DataFrame::create(Named(\"fvn\") = n,\n                                   Named(\"Time\") = Time,\n                                   Named(\"xn1\") = xn1,\n                                   Named(\"vn1\") = vn1,\n                                   Named(\"ln1\") = ln1,\n                                   Named(\"bn\") = bn,\n                                   Named(\"xn\") = xn,\n                                   Named(\"vn\") = vn,\n                                   Named(\"sn\") = sn,\n                                   Named(\"deltav\") = deltav,\n                                   Named(\"vn_ff\") = vn_ff,\n                                   Named(\"vn_cf\") = vn_cf);\n\n  return df;\n\n\n}\n```\n:::\n\n::: {.cell hash='gipps_cache/html/unnamed-chunk-8_7571b39c0438e546d9e9688710ca92b3'}\n\n```{.r .cell-code}\nsimulate_gipps_rcpp <- function(\n\n  ############## Simulation Parameters #######################\n  resolution, # Duration of a time frame. Typical values are 0.1, 0.5, 1.0 s. Double. Must match with the resolution of the observed lead vehicle data dfn1\n  N, # Number of Following Vehicles in the same lane (platoon). Integer.\n\n\n  ############### Lead Vehicle Data #########################\n  dfn1, # Name (unquoted) of the dataframe that contains lead vehicle data.\n  xn1, # Name of the column in dfn1 that contains lead vehicle position. Character.\n  vn1, # Name of the column in dfn1 that contains lead vehicle speed. Character.\n\n\n\n  ############### Following Vehicle Data ####################\n  xn_first, # First value of vehicle position of each of the following vehicles. A list of doubles with size equal to N.\n  vn_first, # First value of vehicle speed of each of the following vehicles. A list of doubles with size equal to N.\n  ln, # Effective size of each of the lead vehicles i.e. vehicle length plus margin of safety. A list of doubles with size equal to N.\n\n\n  ############### Model Parameters ##########################\n  an, # Maximum acceleration which the driver wishes to undertake m/s2. Double.\n  Vn, # Desired speed/speed at which driver  wishes to travel m/s. Double.\n  tau, # Reaction Time s. Double.\n  bn_const, # Most severe braking that the driver wishes to undertake m/s2. Double and Negative.\n  bcap # An estimate of lead vehicle deceleration m/s2. Double and Negative.\n\n\n\n) {\n\n  ####### Time #############################################\n\n  # Last time frame of the simulation:\n  last_time <- (nrow(dfn1) - 1) * resolution\n\n  # Time vector:\n  Time <- seq(from = 0, to = last_time, by = resolution)\n\n  # Length of the Time vector\n  time_length <- length(Time)\n\n\n\n\n\n\n  list_of_N_veh <- vector(mode = \"list\", length = N)\n\n\n  for (n in seq_along(list_of_N_veh)) {\n\n    ####### Assign names to Lead Vehicle Parameters ##########\n\n    if (n == 1L) {\n\n      # Lead vehicle position\n      xn1 <- dfn1[[xn1]]\n\n      # Lead vehicle speed\n      vn1 <- dfn1[[vn1]]\n\n    }\n\n    ln1 <- ln[[n]]\n\n    ####### Allocate Vectors ##################################\n\n    # free-flow speed\n    vn_ff <- rep(NA_real_, time_length)\n\n    # car-following speed\n    vn_cf <- rep(NA_real_, time_length)\n\n    # speed\n    vn <- rep(NA_real_, time_length)\n\n    # position\n    xn <- rep(NA_real_, time_length)\n\n    # spacing\n    sn <- rep(NA_real_, time_length)\n\n    # speed difference\n    deltav <- rep(NA_real_, time_length)\n\n    # acceleration rate\n    bn <- rep(NA_real_, time_length)\n\n    ######## Initial values for Following vehicle ##################################\n\n    # speed\n    vn_ff[1] <- vn_first[[n]]\n    vn_cf[1] <- vn_first[[n]]\n    vn[1] <- vn_first[[n]]\n\n    # position\n    xn[1] <- xn_first[[n]]\n\n    # spacing\n    sn[1] <- xn1[1] - xn_first[[n]]\n\n    # speed difference\n    deltav[1] <- vn_first[[n]] - vn1[1]\n\n    ###### Gipps Calculations ############################\n\n    result_dfn <- for_loop_gipps(resolution,\n                                 n,\n                                 time_length,\n                                 tau,\n                                 an,\n                                 bn_const,\n                                 Vn,\n                                 bcap,\n                                 ln1,\n\n                                 Time,\n                                 vn_ff,\n                                 vn_cf,\n                                 vn,\n                                 vn1,\n                                 sn,\n                                 xn,\n                                 xn1,\n                                 deltav,\n                                 bn\n    )\n\n    ################## Result in a dataframe ###################################\n\n    list_of_N_veh[[n]] <- result_dfn\n\n    xn1 <- result_dfn$xn\n    vn1 <- result_dfn$vn\n\n\n  }\n\n  result <- do.call(\"rbind\", list_of_N_veh)\n\n  # return the result dataframe\n  return(result)\n\n}\n```\n:::\n\n:::\n\n## Running the function on data\n\nThe functions are defined above. Let's run them now with the data of a single car-following pair.\n\n::: panel-tabset\n### R\n\n\n::: {.cell hash='gipps_cache/html/unnamed-chunk-9_5abde25b0d2abb66c88510781bbee2d1'}\n\n```{.r .cell-code}\nresult_r <- simulate_gipps_r(0.1, \n                         1, \n                         \n                         dfn1_r,\n                         'PrecVehLocalY',\n                         'PrecVehVel',\n                         \n                         list(dfn1_r$Local.Y[1]), \n                         list(dfn1_r$svel[1]), \n                         list(unique(dfn1_r$PrecVehLength)), \n                         \n                         2, \n                         max(dfn1_r$svel), \n                         1.2, \n                         -1.5, \n                         -2)\n\nhead(result_r, 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  fvn Time      xn1     vn1    ln1 bcap           bn       xn    vn_ff    vn_cf\n1   1  0.0 66.16815 4.42300 4.3591   -2  4.708065444 50.20508 4.420080 4.420080\n2   1  0.1 66.61045 4.42305 4.3591   -2 -0.688704077 50.67063 6.786645 4.890887\n3   1  0.2 67.05276 4.42308 4.3591   -2 -0.004409401 51.15627 7.210242 4.822016\n        vn       sn     deltav\n1 4.420080 15.96307 -0.0029200\n2 4.890887 11.58072  0.4678365\n3 4.822016 11.53739  0.3989361\n```\n:::\n:::\n\n\n### Rcpp\n\n\n::: {.cell hash='gipps_cache/html/unnamed-chunk-10_df98a71d8af89940b2ca92a5b90f6e83'}\n\n```{.r .cell-code}\nresult_rcpp <- simulate_gipps_rcpp(0.1, \n                         1, \n                         \n                         dfn1_r,\n                         'PrecVehLocalY',\n                         'PrecVehVel',\n                         \n                         list(dfn1_r$Local.Y[1]), \n                         list(dfn1_r$svel[1]), \n                         list(unique(dfn1_r$PrecVehLength)), \n                         \n                         2, \n                         max(dfn1_r$svel), \n                         1.2, \n                         -1.5, \n                         -2)\n\nhead(result_rcpp, 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  fvn Time      xn1     vn1    ln1           bn       xn       vn       sn\n1   1  0.0 66.16815 4.42300 4.3591  4.708065444 50.20508 4.420080 15.96307\n2   1  0.1 66.61045 4.42305 4.3591 -0.688704077 50.67063 4.890887 15.93982\n3   1  0.2 67.05276 4.42308 4.3591 -0.004409401 51.15627 4.822016 15.89649\n      deltav    vn_ff    vn_cf\n1 -0.0029200 4.420080 4.420080\n2  0.4678365 6.805472 4.890887\n3  0.3989361 7.231150 4.822016\n```\n:::\n:::\n\n\n### Julia\n\n\n::: {.cell hash='gipps_cache/html/unnamed-chunk-11_8dfd153eba3d904e39586d46124741d7'}\n\n```{.julia .cell-code}\nresult_julia = simulate_gipps_julia(\n  0.1, \n  1, \n  \n  dfn1_julia,\n  \"PrecVehLocalY\",\n  \"PrecVehVel\",\n  \n  Vector([dfn1_julia[!,\"Local.Y\"][1]]), \n  Vector([dfn1_julia.svel[1]]), \n  Vector(unique(dfn1_julia.PrecVehLength)), \n\n  2, \n  maximum(dfn1_julia.svel), \n  0.1, \n  -1.5, \n  -2\n);\n\n\nfirst(result_julia, 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n3×10 DataFrame\n Row │ fvn    Time     xn1      vn1      ln1      bn        xn        vn       ⋯\n     │ Int64  Float64  Float64  Float64  Float64  Float64?  Float64?  Float64? ⋯\n─────┼──────────────────────────────────────────────────────────────────────────\n   1 │     1      0.0  66.1681  4.423     4.3591   1.97214   50.2051   4.42008 ⋯\n   2 │     1      0.1  66.6105  4.42305   4.3591   1.95774   50.6569   4.61729\n   3 │     1      0.2  67.0528  4.42308   4.3591   1.94046   51.1285   4.81307\n                                                               2 columns omitted\n```\n:::\n:::\n\n:::\n\n## Plotting the results\n\nFollowing plots compare the speed predicted by the Gipps model with the observed speed of the following vehicle.\n\n::: {layout=\"[[40,-5,40]]\"}\n### R\n\n\n::: {.cell hash='gipps_cache/html/unnamed-chunk-12_094df1e9911acd6a2353defd504a408e'}\n\n```{.r .cell-code}\nggplot() +\n  geom_line(data = dfn1_r, \n            aes(Time, svel, color=\"Obs. Speed\")) +\n  geom_point(data = result_r %>% filter(fvn==1), \n             aes(Time, vn, color=\"Gipps. Speed-R\")) +\n  geom_line(data = result_rcpp %>% filter(fvn==1), \n            aes(Time, vn, color=\"Gipps. Speed-Rcpp\"))\n```\n\n::: {.cell-output-display}\n![](gipps_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n### Julia\n\n\n::: {.cell hash='gipps_cache/html/unnamed-chunk-13_b853d09959523eff30c34555ac6d9fcd'}\n\n```{.julia .cell-code}\nusing Plots\np = plot(dfn1_julia.Time, dfn1_julia.svel, label=\"Obs. Speed\");\nplot!(p, result_julia.Time, result_julia.vn, label = \"Gipps Speed\")\n```\n\n::: {.cell-output-display}\n![](gipps_files/figure-html/unnamed-chunk-13-J1.png){width=300}\n:::\n:::\n\n:::\n\n## Measuring the running time\n\nSince the main reason for using `Julia` and `Rcpp` was to speed-up the calculations, I now benchmark the code running time:\n\n::: {layout=\"[[40,-5,40]]\"}\n### R\n\n\n::: {.cell hash='gipps_cache/html/unnamed-chunk-14_6d421ec79ff6081b8b6bdf9520680d6e'}\n\n```{.r .cell-code}\nmicrobenchmark(\n  \"R\" = simulate_gipps_r(0.1, \n                         1, \n                         \n                         dfn1_r,\n                         'PrecVehLocalY',\n                         'PrecVehVel',\n                         \n                         list(dfn1_r$Local.Y[1]), \n                         list(dfn1_r$svel[1]), \n                         list(unique(dfn1_r$PrecVehLength)), \n                         \n                         2, \n                         max(dfn1_r$svel), \n                         1.2, \n                         -1.5, \n                         -2),\n  \"Rcpp\" = simulate_gipps_rcpp(0.1, \n                               1, \n                               \n                               dfn1_r,\n                               'PrecVehLocalY',\n                               'PrecVehVel',\n                               \n                               list(dfn1_r$Local.Y[1]), \n                               list(dfn1_r$svel[1]), \n                               list(unique(dfn1_r$PrecVehLength)), \n                               \n                               2, \n                               max(dfn1_r$svel), \n                               1.2, \n                               -1.5, \n                               -2),\n  times = 1000L,\n  unit = \"ms\"\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nUnit: milliseconds\n expr    min      lq     mean  median      uq     max neval\n    R 5.2794 5.71390 6.440167 6.05135 6.52950 38.2684  1000\n Rcpp 1.2979 1.46895 1.780119 1.55145 1.75615 14.1584  1000\n```\n:::\n:::\n\n\n### Julia\n\n\n::: {.cell hash='gipps_cache/html/unnamed-chunk-15_6b79f17b3f59bd2c37484e67feff654b'}\n\n```{.julia .cell-code}\n@benchmark simulate_gipps_julia(\n  0.1, \n  1, \n  \n  dfn1_julia,\n  \"PrecVehLocalY\",\n  \"PrecVehVel\",\n  \n  Vector([dfn1_julia[!,\"Local.Y\"][1]]), \n  Vector([dfn1_julia.svel[1]]), \n  Vector(unique(dfn1_julia.PrecVehLength)), \n  \n  2, \n  maximum(dfn1_julia.svel), \n  0.1, \n  -1.5, \n  -2\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nBenchmarkTools.Trial: 4286 samples with 1 evaluation.\n Range (min … max):  941.700 μs …   5.675 ms  ┊ GC (min … max): 0.00% … 78.73%\n Time  (median):       1.056 ms               ┊ GC (median):    0.00%\n Time  (mean ± σ):     1.157 ms ± 389.636 μs  ┊ GC (mean ± σ):  2.42% ±  6.91%\n\n  ▆██▇▆▅▅▄▄▃▂▂▁▁▁                                               ▂\n  █████████████████▇▅█▇▇▆▇▇▆▄▆▄▅▃▆▄▅▅▄▃▅▅▄▁▅▃▄▄▄▅▅▁▅▁▄▃▄▄▁▃▃▃▄▄ █\n  942 μs        Histogram: log(frequency) by time       3.25 ms <\n\n Memory estimate: 424.88 KiB, allocs estimate: 20491.\n```\n:::\n:::\n\n:::\n\nThe results clearly show that both `Julia` and `Rcpp` are significantly faster than `R`. Therefore, using the `Julia` implementation would save a lot of time if I use this function in simulations and calibration.\n\nPlease leave comments below to suggest any improvements. Feel free to use the code in this post if you find anything useful.\n\nAnimation Bonus:\n\n\n::: {.cell hash='gipps_cache/html/unnamed-chunk-16_5ef8894548fb0e3a5c88e4a64b9ac933'}\n\n```{.r .cell-code  code-fold=\"true\"}\nlibrary(gganimate)\n\nggplot(data = result_r) +\n  geom_rect(aes(xmin = xn1 - ln1,\n                xmax = xn1,\n                \n                ymin = 0.628,\n                ymax = 3.028)) +\n  geom_rect(aes(group = fvn,\n                fill = as.factor(fvn),\n                xmin = xn - 5,\n                xmax = xn,\n                \n                ymin = 0.628,\n                ymax = 3.028)) +\n  # geom_hline(yintercept = 3.6, linetype = \"longdash\", color = \"white\") +\n  geom_text(aes(x=xn-2, y = 6, \n                label = paste(\"Following Car\\nSpeed =\", round(vn,2), \"m/s\")),\n            color = \"white\") +\n  geom_text(aes(x=xn1-2, y = 6, color = \"white\",\n                label = paste(\"Lead Car\\nSpeed =\", round(vn1,2), \"m/s\")),\n            color = \"white\") +\n  geom_segment(aes(x = xn,\n                   xend = xn1-(unique(dfn1_r$PrecVehLength)),\n                   y = 2.5,\n                   yend= 2.5), color = \"white\",\n               arrow = arrow(length = unit(0.1, \"inches\"), ends = \"both\")) +\n  geom_text(aes(x=xn + 0.5*sn, y = 1.5, color = \"white\",\n                label = paste(\"Spacing =\", round(sn,2), \"m\")),\n            color = \"white\") +\n  coord_equal(ratio=0.7) +\n  transition_manual(Time) +\n  ease_aes() +\n  view_follow()+\n  theme_void() +\n  theme(legend.position = \"none\",\n        panel.background = element_rect(fill = \"black\", color = \"black\"))\n```\n\n::: {.cell-output-display}\n![](gipps_files/figure-html/unnamed-chunk-16-1.gif)\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}